<!-- <!DOCTYPE html> -->

<html lang="{{ get_locale() }}">
  <head>
    <meta charset="utf-8" />
    <title>{% block title %} {% endblock %}</title>

    {% block head %} {% include 'base-css.html' %} {% endblock %}
  </head>
  <body>
    <!-- Main Wrapper -->
    <div class="loader">
      {% block loading %} {% include 'base-loading.html' %} {% endblock %}
    </div>

    <div class="main-wrapper">
      <!-- Header -->
      <header class="header">
        <nav class="navbar navbar-expand-lg header-nav">
          <div class="navbar-header">
            <a id="mobile_btn" href="javascript:void(0);">
              <span class="bar-icon">
                <span></span>
                <span></span>
                <span></span>
              </span>
            </a>
            <a href="{{ url_for('home') }}" class="navbar-brand logo">
              <?xml version="1.0" encoding="UTF-8"?>
              <svg
                id="svg4171"
                xmlns="http://www.w3.org/2000/svg"
                xmlns:xlink="http://www.w3.org/1999/xlink"
                viewBox="0 0 148.6 53.1"
              >
                <defs>
                  <style>
                    .cls-1 {
                      fill: url(#linear-gradient);
                    }
                  </style>
                  <linearGradient
                    id="linear-gradient"
                    x1="0"
                    y1="26.55"
                    x2="148.6"
                    y2="26.55"
                    gradientUnits="userSpaceOnUse"
                  >
                    <stop offset="0" stop-color="#69f8fd" />
                    <stop offset=".17" stop-color="#4de5f9" />
                    <stop offset=".32" stop-color="#26caf3" />
                    <stop offset=".53" stop-color="#1cabe4" />
                    <stop offset=".69" stop-color="#0d7dce" />
                    <stop offset=".85" stop-color="#0361c0" />
                    <stop offset="1" stop-color="#0056bb" />
                  </linearGradient>
                </defs>
                <path
                  class="cls-1"
                  d="M56.3,9.86c2.2,0,3.8,1.6,3.8,3.6s-1.7,3.5-3.8,3.5-3.8-1.6-3.8-3.5c0-2,1.7-3.6,3.8-3.6Zm-3.1,31.9V20.46h6.2v21.3h-6.2Zm13.4,0V11.06h11.9c9.5,0,16.4,5.7,16.4,15.4s-7,15.3-16.4,15.3h-11.9Zm11.6-5.6c5.4,0,10-3.1,10-9.8s-4.5-9.8-9.9-9.8h-5.2v19.6h5.1Zm44.3-5.1c0,6.5-5.2,11.3-12.1,11.3s-12.1-4.8-12.1-11.3,5.2-11.3,12.1-11.3,12.1,4.7,12.1,11.3Zm-6.2,0c0-4-2.8-6.1-5.8-6.1s-5.8,2-5.8,6.1,2.8,6.1,5.8,6.1,5.8-2.1,5.8-6.1Zm15.6,0c0,3.9,2.7,6,5.9,6s4.8-2,5.3-3.6l5.5,1.7c-1,3.6-4.6,7.2-10.8,7.2-6.8,0-12.1-4.8-12.1-11.3s5.2-11.3,11.9-11.3c6.3,0,9.8,3.6,10.8,7.2l-5.6,1.7c-.6-1.8-2-3.6-5.1-3.6-3.1,0-5.8,2.2-5.8,6ZM45.1,52.3h1.9c-3.3-8.1-9.2-14.2-16.3-16.8-.6-.6-1.3-1.2-2.2-1.7,3-2.1,5.8-5.7,7.4-10.1,1.6-.2,2.9-1.6,2.9-3.2,0-1.3-.8-2.4-1.8-2.9v-.2c0-9.9-1.2-17.4-13.3-17.4S10.3,7.6,10.3,17.4v.2c-1,.5-1.8,1.6-1.8,2.9,0,1.7,1.3,3.1,2.9,3.2,1.6,4.4,4.5,8,7.4,10.1-.8,.5-1.6,1-2.2,1.6-7.2,2.4-13.2,8.7-16.6,16.9H1.9c2.8-6.4,7.2-11.5,12.7-14.2-.4,.7-.7,1.5-.9,2.2-1,3.3-.5,6.3-.4,6.4v.1c-1.1,.6-1.8,1.8-1.5,3.1,.2,1.4,1.5,2.4,2.9,2.4h.5c1.6-.3,2.6-1.8,2.4-3.4-.2-1.3-1.3-2.2-2.5-2.4v-.1s-.5-2.7,.4-5.6c.5-1.5,1.2-2.8,2.2-3.9,.3-.1,.6-.2,.9-.3l-.5,1.7c-.2,.4-.3,.8-.3,1.2-.1,.3-.1,.7-.1,1,0,3.3,2.7,6,6,6s6-2.7,6-6c0-.4,0-.7-.1-1-.1-.5-.2-1-.4-1.4l-.4-1.4c.3,.1,.7,.2,1,.3,1.3,1.4,2,3,2.3,4.5-.4,.2-.8,.4-1.2,.6-1.1,.8-1.9,2-2.1,3.4l-.5,2.8c-.6,.2-1,.7-1.1,1.3-.1,.5,0,.9,.3,1.3s.7,.6,1.1,.7h.3c.8,0,1.6-.6,1.7-1.4,.1-.5,0-.9-.3-1.3-.1-.1-.2-.2-.3-.3l.5-2.8c.2-.9,.7-1.7,1.4-2.2,.2-.1,.3-.2,.5-.3,.5-.3,1.1-.4,1.7-.3h.4c.9,.2,1.7,.7,2.2,1.4,.5,.8,.7,1.7,.6,2.6l-.5,2.8c-.6,.2-1,.7-1.1,1.3-.1,.4,0,.8,.2,1.2,.2,.4,.7,.8,1.2,.8h.3c.6,0,1.2-.3,1.5-.9,.1-.2,.2-.4,.2-.6,.1-.6-.1-1.2-.6-1.6l.5-2.8c.2-1.4-.1-2.7-.9-3.9-.8-1.1-2-1.9-3.4-2.1-.3-.1-.7-.1-1-.1-.1-.3-.1-.6-.2-.9-.2-.6-.5-1.3-.8-2,5.3,2.8,9.7,7.8,12.4,14.1h0Zm-8.1-33.3c.4,.4,.7,.9,.7,1.5,0,.9-.5,1.6-1.3,1.9,.3-1.1,.5-2.2,.6-3.4Zm-27.2,1.5c0-.6,.2-1.1,.6-1.4v.1c.1,1.1,.3,2.2,.6,3.2-.7-.3-1.2-1.1-1.2-1.9h0Zm6.1,28.7c.1,.3,0,.6-.2,.9s-.4,.4-.8,.5h-.2c-.6,0-1-.4-1.1-1s.3-1.2,.9-1.3h.2c.6-.1,1.1,.3,1.2,.9h0Zm7.8-4.4c-2.4,0-4.3-1.9-4.3-4.3,0-.2,0-.4,.1-.7l.3-1.1,.7-2.5,.4-1.3c1,.5,2,.7,2.8,.7,.9,0,1.8-.2,2.8-.6l.4,1.2,.7,2.3,.4,1.3v.6c0,2.5-2,4.4-4.3,4.4h0Zm0-10.8h-.1c-.7,0-1.4-.3-2.3-.7-.2-.1-.4-.2-.6-.3-.3-.2-.6-.4-1-.6-2.5-1.8-5.1-5-6.6-8.9-.1-.4-.3-.8-.4-1.2-.3-1-.5-2.1-.7-3.2,.1-.2,.2-.3,.3-.5,.3-.4,.5-.7,.8-1,2.2-2.3,5.3-2.8,8.8-3.4,1.3-.2,2.7-.5,4.1-.8,1.8-.4,3.1-1.4,3.9-2.8,1.6-2.8,.5-6.6,.5-6.7-.1-.5-.6-.7-1.1-.6-.5,.1-.7,.6-.6,1.1,0,0,.9,3.2-.3,5.4-.6,1-1.5,1.6-2.8,2-1.3,.3-2.7,.6-4,.8-3.7,.6-7.2,1.2-9.8,3.9,.1-10.1,2-14.7,11.6-14.7,6.5,0,8.7,2.4,9.7,4.1,1.5,2.7,1.9,6.5,1.9,11.4v1.2c-.1,1.3-.3,2.5-.7,3.7-.1,.4-.2,.8-.4,1.2-1.4,4-4.1,7.3-6.7,9.1-.3,.2-.5,.3-.7,.5-.3,.2-.5,.3-.8,.4-.8,.3-1.5,.5-2,.6,.1-.1,0-.1,0,0h0Z"
                />
              </svg>
            </a>
          </div>
          <ul class="nav header-navbar-rht">
            <li class="nav-item dropdown logged-item mr-3" id="language-select">
              <a
                class="dropdown-toggle"
                href="#"
                data-toggle="dropdown"
                id="language"
                aria-haspopup="true"
                aria-expanded="true"
              >
                {% if get_locale() == 'en' %}
                <img
                  class="img-fluid"
                  src="../static/img/en.png"
                  alt="English"
                />
                {% elif get_locale() == 'ar' %}
                <img
                  class="img-fluid"
                  src="../static/img/ar.png"
                  alt="Arabic"
                />
                {% endif %}
              </a>
              <div
                class="dropdown-menu user-dropmenu dropdown-menu-right"
                aria-labelledby="language"
                style="max-width: 50px; min-width: 50px"
              >
                <div class="dropdown-item" data-lang="en">
                  <img
                    class="img-fluid"
                    src="../static/img/en.png"
                    alt="English"
                  />
                </div>
                <div class="dropdown-item" data-lang="ar">
                  <img
                    class="img-fluid"
                    src="../static/img/ar.png"
                    alt="Arabic"
                  />
                </div>
              </div>
            </li>
            {% if current_user.is_authenticated and current_user.user_roles.role.role_name
            == 'clinic'%}
            <!-- Notifications -->
            <li class="nav-item dropdown noti-dropdown mr-3">
              <a
                href="#"
                class="dropdown-toggle nav-link p-2"
                data-toggle="dropdown"
              >
                <i class="far fa-bell" style="color: #015cbd"></i>
                <span
                  id="notification-count"
                  class="badge badge-pill"
                  style="background-color: #015cbd"
                  >{{notification_count}}</span
                >
              </a>
              <div class="dropdown-menu notifications">
                <div class="topnav-dropdown-header">
                  <span class="notification-title"
                    >{{ translate('Notifications') }}</span
                  >
                  <a
                    href="{{ url_for('clear_noti') }}"
                    class="clear-noti"
                    id="clear-all-notifications"
                  >
                    {{ translate('Clear All') }}
                  </a>
                </div>
                <div class="noti-content">
                  <ul class="notification-list" id="notification-list">
                    {% if notifications %} {% for notification in notifications
                    %}
                    {% if notification.isRead %}
                    <li class="notification-message">
                      {% else %}
                    <li class="notification-message alert-info">
                      {% endif %}
                      <a href="{{ url_for('clear_noti') }}">
                        <div class="media">
                          <span class="avatar avatar-sm">
                            {% set base_path = 'static/images/doctors/' %}
                            <img
                              class="avatar-img rounded-circle"
                              alt="User Image"
                              src="{{base_path ~ notification.photo}}"
                            />
                          </span>
                          <div class="media-body">
                            <p class="noti-details">
                              <span class="noti-title"
                                >{{notification.patient}}</span
                              >
                              has booked appointment to
                              <span class="noti-title"
                                >Dr. {{notification.doctor}}</span
                              >
                              on
                              <span class="noti-title"
                                >{{notification.date}} at
                                {{notification.time}}</span
                              >
                            </p>
                            <p class="noti-time">
                              <span class="notification-time"
                                >{{notification.formatted_time}}</span
                              >
                            </p>
                          </div>
                        </div>
                      </a>
                    </li>
                    {% endfor %} {% endif %}
                  </ul>
                </div>
                <div class="topnav-dropdown-footer">
                  <a href="#">{{ translate('View all Notifications') }}</a>
                </div>
              </div>
            </li>
            <!-- /Notifications -->
            {% endif %}
            <!-- User Menu -->
            {% if current_user.is_authenticated %}
            <li class="nav-item dropdown has-arrow logged-item mr-3">
              <a
                class="dropdown-toggle"
                href="#"
                data-toggle="dropdown"
                aria-haspopup="true"
                aria-expanded="true"
              >
                <span class="user-img">
                  <img
                    class="rounded-circle"
                    src="{{current_user.photo}}"
                    width="31"
                    alt="user image"
                  />
                </span>
              </a>
              <div class="dropdown-menu user-dropmenu dropdown-menu-right">
                <div class="user-header align-items-center">
                  <div class="avatar avatar-sm">
                    <img
                      src="{{current_user.photo}}"
                      alt="User Image"
                      class="avatar-img rounded-circle"
                    />
                  </div>
                  <div class="user-text">
                    <h6>{{ current_user.name }}</h6>
                    <p class="text-muted mb-0">
                      {{ current_user.user_roles.role.role_name }}
                    </p>
                  </div>
                </div>

                {% if current_user.user_roles.role.role_name == 'Admin' %}
                <a class="dropdown-item" href="{{ url_for('dashboard') }}"
                  >{{ translate('Dashboard') }}</a
                >
                {% elif current_user.user_roles.role.role_name == 'doctor' %}
                <a class="dropdown-item" href="{{ url_for('doctor_dash') }}"
                  >{{ translate('Dashboard') }}</a
                >
                {% elif current_user.user_roles.role.role_name == 'clinic' %}
                <a class="dropdown-item" href="{{ url_for('clinic_dash') }}"
                  >{{ translate('Dashboard') }}</a
                >
                {% endif %}
                <a class="dropdown-item" href="{{ url_for('logout_page') }}"
                  >{{ translate('Logout') }}</a
                >
              </div>
            </li>
            {% endif %}

            <!-- /User Menu -->
          </ul>
        </nav>
        {% block alert %} {% include 'base-alert.html' %} {% endblock %}
      </header>
      <!-- /Header -->


      {% block body %}


      {% endblock %}
      <!-- Future Content here -->

      <!-- Footer -->
      {% block footer %} {% include 'base-footer.html' %} {% endblock %}

      <!-- /Footer -->
    </div>
    <!-- /Main Wrapper -->
    {% block js %} {% include 'base-js.html' %}
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script type="text/javascript">
      document.addEventListener("DOMContentLoaded", (event) => {
        var clinic_id = "{{ current_user.clinic_id }}";

        if (!clinic_id) {
          console.error(
            "Clinic ID is missing. Cannot establish WebSocket connection."
          );
          return;
        }

        console.log("Connecting with clinic_id:", clinic_id);

        var socket = io.connect("http://localhost:5000", {
          query: "clinic_id=" + clinic_id,
          transports: ["websocket", "polling"],
        });

        socket.on("connected", function (msg) {
          console.log(msg.message);
        });

        socket.on("appointment_notification", function (data) {
          console.log("Appointment notification:", data);
          addNotification(data, true);
        });

        socket.on("disconnected", function (msg) {
          console.log(msg.message);
        });

        function addNotification(data, store = false) {
          var notificationList = document.getElementById("notification-list");
          var notificationCount = document.getElementById("notification-count");

          var newNotification = document.createElement("li");
          newNotification.classList.add("notification-message");

          var currentTime = new Date();
          var formattedTime = currentTime.toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
          });
          var notificationContent = `
              <div class="media">
                <span class="avatar avatar-sm">
                  <img class="avatar-img rounded-circle" alt="User Image" src="static/images/doctors/${data.photo}">
                </span>
                <div class="media-body">
                  <p class="noti-details">
                    <span class="noti-title">${data.patient}</span>
                    has booked appointment to
                    <span class="noti-title">Dr. ${data.doctor}</span> on
                    <span class="noti-title">${data.date} at ${data.time}</span>
                  </p>
                  <p class="noti-time">
                    <span class="notification-time">${formattedTime}</span>
                  </p>
                </div>
              </div>
          `;

          newNotification.innerHTML = notificationContent;
          notificationList.prepend(newNotification);

          var currentCount = parseInt(notificationCount.textContent);
          notificationCount.textContent = currentCount + 1;

          if (store) {
            storeNotification(data);
          }
        }

        function storeNotification(data) {
          var notifications =
            JSON.parse(localStorage.getItem("notifications")) || [];
          notifications.unshift(data);
          localStorage.setItem("notifications", JSON.stringify(notifications));
        }

        function loadNotifications() {
          var notifications =
            JSON.parse(localStorage.getItem("notifications")) || [];
          notifications.forEach((notification) => {
            addNotification(notification, false);
          });
        }

        document
          .getElementById("clear-all-notifications")
          .addEventListener("click", function () {
            clearAllNotifications();
          });

        function clearAllNotifications() {
          var notificationList = document.getElementById("notification-list");
          var notificationCount = document.getElementById("notification-count");
          if (notificationList && notificationCount) {
            notificationList.innerHTML = "";
            notificationCount.textContent = "0";
            localStorage.removeItem("notifications");
          }
        }

        loadNotifications();
      });
    </script>

    {% endblock %}
  </body>
</html>
